Advanced SQL
  
   Week 1


----------------------------------------------------
   --- Combining Data With Multiple Joins ---
----------------------------------------------------

  --For the flight routes highlighted in question 4 combined, would there have been an aircraft that, on average, would use less fuel on the flight routes? 

--The fuel used in liters per flight can be calculated by multiplying the fuel efficiency metric by distance, baggage weight, and number of passengers. 

--What aircraft (manufacturer and sub-type) would you recommend to use for each of these flight routes if you use the average fuel consumption as your guiding metric?

--If the manufacturer and sub-type are not available for flights, we do not need to show the results of these flights.


SELECT 
    aircraft.manufacturer
    , aircraft.ac_subtype
    , AVG(fuel.fuel_efficiency * flights.total_passengers * flights.baggage_weight * routes.distance_flown) AS avg_fuel_consumption

FROM ba_flights flights

LEFT JOIN ba_flight_routes routes ON flights.flight_number = routes.flight_number
INNER JOIN ba_aircraft aircraft ON flights.flight_id = aircraft.flight_id
LEFT JOIN ba_fuel_efficiency fuel on aircraft.ac_subtype = fuel.ac_subtype

WHERE 1=1
   AND routes.departure_city in ('London')
   AND routes.arrival_city in ('Basel', 'Trondheim', 'Glasgow') 
   AND aircraft.manufacturer IS NOT NULL
   AND aircraft.ac_subtype IS NOT NULL

GROUP BY aircraft.manufacturer
    , aircraft.ac_subtype

ORDER BY avg_fuel_consumption
--LIMIT 1
;




  Week 2

------------------------------------------------
   --- Cleaning and Analyzing Messy Data ---
------------------------------------------------

/*Your manager wants to analyze the marketing spend percentage by country, but the data is not 100% clean. He mentions that you can clean the country field by using the sales team information, and shared the following mapping with you: 

UK = United Kingdom
FR = France
ES = Spain
IT = Italy
DACH = Germany

What is the average marketing spend percentage per country?
*/

SELECT * FROM meta_clients

SELECT 
     CASE 
         WHEN sales_team LIKE '%_FR_%' THEN 'France'
         WHEN sales_team LIKE '%_UK_%' THEN 'United Kingdom'
         WHEN sales_team LIKE '%_ES_%' THEN 'Spain'
         WHEN sales_team LIKE '%_IT_%' THEN 'Italy'
         WHEN sales_team LIKE '%_DACH_%' THEN 'Germany'
      ELSE 'REGION'
      END AS clean_country
       , AVG(marketing_spend_perc)
FROM meta_clients
GROUP BY 
        clean_country
    

WEEK 3

-----------------------
    --- CTE'S ---
-----------------------

--What is the total revenue generated by Nike Official and Nike Vintage combined from customers that purchased more than 1 product?


with items_combined as (

  select 
   *
from order_items
union all
select 
   *
from order_items_vintage
  
)

, customer_order_items as (
  
select 
    user_id
    , count(distinct product_id) as total_orders
    , sum(sale_price) as total_revenue
from items_combined
group by user_id

)

select 
    sum(total_revenue)
from customer_order_items
where 1=1
    and total_orders > 1











