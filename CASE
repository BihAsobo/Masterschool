--Our colleague from Marketing, Humberto, comes to us with a data request. Specifically, he is wondering how many advertisers are reaching users domestically versus internationally.
--Question #1: 
--Summarize the number of clicks that have been generated(use SUM aggregate) for each year where the user and the advertiser have the same geographical code

SELECT * FROM meta_revenue

SELECT
    years
    , SUM(clicks) as sum
FROM meta_revenue
WHERE 1=1
    AND geo_user = geo_advertiser
GROUP BY years
;


--Question #2: 
--Create a new column that splits the data between domestic activity and international activity. Domestic activity means that the user and advertiser have the same geography code. International activity means that the user and advertiser have a different geography codes.

--How much revenue has been generated through domestic activity versus international activity in 2022 for each platform (Instagram and Facebook)?

SELECT * from meta_revenue

SELECT
    parent_company
    , CASE
        WHEN geo_user = geo_advertiser THEN 'Domestic Activity'
        WHEN geo_user != geo_advertiser THEN 'International Activity'
        ELSE 'error'
    END AS geo_group
    , SUM(revenue) AS total_revenue
FROM meta_revenue
WHERE 1=1
    AND years = 2022
GROUP BY parent_company
    , geo_group

;


--Domestic activity is small compared to international activity - an insight you share with Humberto. He is surprised by these results, and asks you to dive deeper into the data to understand if there is a driving factor behind this.
--Question #3: 
--Analyze if there is a clear distinction in the sales of the LCS (Large Customer Sales) and SMB (Small and Medium Businesses) sales teams. Anything that doesn’t match LCS or SMB can be called Other.
--How much revenue did the LCS and SMB sales teams generate in 2022 split between domestic and international activity?

SELECT * FROM meta_revenue

SELECT
    CASE
        WHEN sales_team LIKE '%LCS%' THEN 'LCS'
        WHEN sales_team LIKE '%SMB%' THEN 'SMB'
        ELSE 'Other'
    END AS sales_segment
        , CASE
            WHEN geo_user = geo_advertiser THEN 'Domestic Activity'
            WHEN geo_user != geo_advertiser THEN 'International Activity'
            ELSE 'error'
        END AS geo_group
        , SUM(revenue) AS total_revenue
        
FROM meta_revenue
WHERE 1=1
    AND years = 2022
GROUP BY sales_segment
    , geo_group
ORDER BY sales_segment

 --Our colleague from Marketing, Humberto, comes to us with a data request. Specifically, he is wondering how many advertisers are reaching users domestically versus internationally.
--Question #1: 
--Summarize the number of clicks that have been generated(use SUM aggregate) for each year where the user and the advertiser have the same geographical code

SELECT * FROM meta_revenue

SELECT
    years
    , SUM(clicks) as sum
FROM meta_revenue
WHERE 1=1
    AND geo_user = geo_advertiser
GROUP BY years
;


--Question #2: 
--Create a new column that splits the data between domestic activity and international activity. Domestic activity means that the user and advertiser have the same geography code. International activity means that the user and advertiser have a different geography codes.

--How much revenue has been generated through domestic activity versus international activity in 2022 for each platform (Instagram and Facebook)?

SELECT * from meta_revenue

SELECT
    parent_company
    , CASE
        WHEN geo_user = geo_advertiser THEN 'Domestic Activity'
        WHEN geo_user != geo_advertiser THEN 'International Activity'
        ELSE 'error'
    END AS geo_group
    , SUM(revenue) AS total_revenue
FROM meta_revenue
WHERE 1=1
    AND years = 2022
GROUP BY parent_company
    , geo_group

;


--Domestic activity is small compared to international activity - an insight you share with Humberto. He is surprised by these results, and asks you to dive deeper into the data to understand if there is a driving factor behind this.
--Question #3: 
--Analyze if there is a clear distinction in the sales of the LCS (Large Customer Sales) and SMB (Small and Medium Businesses) sales teams. Anything that doesn’t match LCS or SMB can be called Other.
--How much revenue did the LCS and SMB sales teams generate in 2022 split between domestic and international activity?

SELECT * FROM meta_revenue

SELECT
    CASE
        WHEN sales_team LIKE '%LCS%' THEN 'LCS'
        WHEN sales_team LIKE '%SMB%' THEN 'SMB'
        ELSE 'Other'
    END AS sales_segment
        , CASE
            WHEN geo_user = geo_advertiser THEN 'Domestic Activity'
            WHEN geo_user != geo_advertiser THEN 'International Activity'
            ELSE 'error'
        END AS geo_group
        , SUM(revenue) AS total_revenue
        
FROM meta_revenue
WHERE 1=1
    AND years = 2022
GROUP BY sales_segment
    , geo_group
ORDER BY sales_segment

-- Suppose we are on the Data team at Meta and our Marketing colleague Humberto reaches out to us for insights to prepare him for his presentation about revenue trends. The presentation is still a few months away, but he wants to start getting a sense of the numbers.

--Let’s make sure we understand some high-level numbers about the revenue of the last couple of years to make sure Humberto can answer the quick questions during the presentation.

--Question #1: 
--How has the revenue of Instagram changed over the years? Provide a summary of total revenue per year for Instagram.

SELECT * FROM meta_revenue

SELECT
    SUM(revenue) AS total_revenue -- we use SUM when looking for a 'total' of something
    , years
FROM meta_revenue
WHERE 1=1
    AND parent_company = 'Instagram'
GROUP BY years, parent_company -- always use GROUP BY when there`s an aggregated and non aggregated function present
;
    
    
--Question #2: 
--What is the 'revenue' in '2022 and 2021'  generated by the Video ad type on both platforms (Facebook and Instagram)
--combined? Did revenue grow?

SELECT 
    years
    , SUM(revenue) as total_revenue
FROM meta_revenue
WHERE 1=1
    AND years in ('2022', '2021')
    AND ad_types in ('Facebook Video', 'Instagram Video')
GROUP BY years
;
    

--When analyzing the ad types available in the dataset, you realize that there is no easy way of splitting the Display ads and Video ads across platforms. We only have them split per platform (e.g., we have Instagram Display and Facebook Display).

--Humberto will need insights about the Display and Video ads across platforms, so some work is needed to make that happen.

--Question #3: 
--Create a column called “ad_products” that creates one value that groups the Display ad types together and one value that groups the Video ad types together. 

--What is the total revenue generated by each ad product? 


SELECT * FROM meta_revenue

SELECT
    CASE --used when filtering conditions and adding a new column. It`s followed by WHEN, THEN, ELSE and END AS(END AS is the new column name)
        WHEN ad_types in ('Facebook Display', 'Instagram Display') THEN 'Display Ad'
        WHEN ad_types in ('Facebook Video', 'Instagram Video') THEN 'Video Ad'
        ELSE 'Other'
    END AS ad_products
    , SUM(revenue) AS total_revenue
FROM meta_revenue
GROUP BY ad_products
;



--Video ads have been booming in the last few years. Because of this, Video ads are a topic of interest for Humberto. He wants to identify high performing Video ads for further investigation by the Marketing experts on his team.
--Question #4: 
--Can you identify the ad_id of Video ads that have generated over 2 million in revenue in 2022? 
--Note: the revenue numbers are already in millions, so 2 million will show up as 2 in the data.


SELECT * FROM meta_revenue

SELECT
    ad_id
    , SUM(revenue) AS total_revenue
FROM meta_revenue
WHERE 1=1
    AND ad_types LIKE '%Video%'
    AND years = 2022
    
GROUP BY ad_id

HAVING SUM(revenue) > 2 --use Having to filter the aggregated results. The sum on line two will gives you the total revenue of all the data.meta_revenue
--and as a result you would need to use group by
--but since we need the total revenue for ad id`s above 2million only, we need to filter the total revenue sum results to give us only those id`d that generated abv 2million using the HAVING function
;
    
    
--ADDITIONAL PRACTICE

SELECT 
    *
FROM meta_revenue


--Question #1: 
--What is the number of impressions in 2022 per age group across Facebook and Instagram?

SELECT
    COUNT(impressions) AS total_impressions
    , age_bucket_user
    , parent_company
FROM meta_revenue
WHERE 1=1
    AND years = 2022
    AND parent_company IN ('Facebook', 'Instagram')
GROUP BY age_bucket_user
         , parent_company
;



--Question #2: 
--Have the number of conversions(use SUM function and group by years) been trending upwards or downwards for Facebook for the age bucket 18-24 and 25-34 over the last few years?

SELECT * FROM meta_revenue

SELECT
    SUM(conversions) AS total_conversions
    , years
FROM meta_revenue
WHERE 1=1
    AND parent_company = 'Facebook'
    AND age_bucket_user >= '18-24' AND age_bucket_user <= '25-34'
GROUP BY years
    

--Question #3: 
--A standard metric to analyze in the ads business is called conversion-per-click which is defined as your total conversion value divided by the number of clicks.
--Can you build the conversion-per-click metric and analyze how the metric is trending for Instagram for the age bucket 18-24 over the last few years?

SELECT
    years
    , SUM(conversions) / SUM(clicks) AS conversion_per_clicks
FROM meta_revenue
WHERE 1=1
    AND parent_company = 'Instagram'
    AND age_bucket_user = '18-24' 
GROUP BY years
;
    
--Question #4: 
--Create a column that summarizes the dates based on the calendar quarters in the year (e.g., Q1 is 2022-01-01 to 2022-03-31). 
--What is the revenue and number of conversions generated per quarter for the SMB sales team in 2022?


SELECT
    CASE 
        WHEN dates BETWEEN ('2022-01-01') AND ('2022-03-31') THEN 'Q1'
        WHEN dates BETWEEN ('2022-04-01') AND ('2022-06-30') THEN 'Q2'
        WHEN dates BETWEEN ('2022-07-01') AND ('2022-09-30') THEN 'Q3'
        WHEN dates BETWEEN ('2022-10-01') AND ('2022-12-31') THEN 'Q4'
    END AS quarter
    , SUM(revenue) AS total_revenue
    , SUM(conversions) AS total_conversions
FROM meta_revenue
WHERE 1=1
    AND years = 2022
    AND sales_team LIKE 'SMB%'
GROUP BY quarter
ORDER BY quarter
;


--Question #5: 
--What is the average amount of revenue per ad that is generated per quarter for the SMB sales team in 2022?

SELECT
    CASE 
        WHEN dates BETWEEN ('2022-01-01') AND ('2022-03-31') THEN 'Q1'
        WHEN dates BETWEEN ('2022-04-01') AND ('2022-06-30') THEN 'Q2'
        WHEN dates BETWEEN ('2022-07-01') AND ('2022-09-30') THEN 'Q3'
        WHEN dates BETWEEN ('2022-10-01') AND ('2022-12-31') THEN 'Q4'
    END AS quarter
    , SUM(revenue) / COUNT(DISTINCT ad_id) AS total_revenue_ad
FROM meta_revenue
WHERE 1=1
    AND years = 2022
    AND sales_team LIKE 'SMB%'
GROUP BY quarter
ORDER BY quarter
;



--Question #6: 
--Calculate the following metrics for the top 10 clients that have the highest amount of revenue in 2022: 
--Total revenue, total conversions, total clicks, conversions per click, and average revenue per conversion


SELECT
    client_id
    , SUM(revenue) AS total_revenue
    , SUM(conversions) AS total_conversions
    , SUM(conversions) / SUM(clicks) AS conversion_per_clicks
    , sum(revenue) / SUM(conversions) AS average_revenue_per_conversion
FROM meta_revenue
WHERE 1=1
    AND years = 2022
GROUP BY client_id
Limit 10
;









    
    
    
    
    
    
    
    
       
    
    
    
    
    
    
    
    